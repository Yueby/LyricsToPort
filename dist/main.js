(()=>{var n="LyricsToPort";var S={RECONNECT_DELAY:3e3,MAX_QUEUE_SIZE:100,MAX_RECONNECT_ATTEMPTS:5};var c={[0]:"RefinedNowPlaying",[1]:"LibLyric",[2]:"\u8F6F\u4EF6\u5185\u6B4C\u8BCD"},a={PORT:`${n}.config.port`,LYRIC_SOURCE:`${n}.config.lyricSource`};var u=null;async function A(){if(!window.onProcessLyrics)return console.log(`[${n}] RefinedNowPlaying \u672A\u52A0\u8F7D`),null;let t=await new Promise(e=>{let r=window.onProcessLyrics;window.onProcessLyrics=o=>{console.log(`[${n}] RefinedNowPlaying \u539F\u59CB\u6570\u636E:`,{hasCallback:!!r,rawLyrics:o}),r(o),e(window.currentLyrics),window.onProcessLyrics=r}});return t?.lyrics?.length>0?(console.log(`[${n}] \u4ECE RefinedNowPlaying \u83B7\u53D6\u6B4C\u8BCD:`,t),{lines:t.lyrics}):(console.log(`[${n}] RefinedNowPlaying \u672A\u8FD4\u56DE\u6709\u6548\u6570\u636E`),null)}async function h(t){let e=await loadedPlugins.liblyric.getLyricData(t);if(console.log(`[${n}] \u539F\u59CB\u6B4C\u8BCD\u6570\u636E:`,e),e.code!==200)return console.error(`[${n}] \u6B4C\u8BCDAPI\u9519\u8BEF:`,e.error),null;let r=(e.lrc?.lyric??"").replace(/\u3000/g," "),o=e.tlyric?.lyric??"",i=e.romalrc?.lyric??"",g=e.yrc?.lyric??"";return{lines:loadedPlugins.liblyric.parseLyric(r,o,i,g)}}async function O(){try{let t=await betterncm.utils.waitForElement("#x-g-mn .m-lyric",100);if(!t)return console.error(`[${n}] \u65E0\u6CD5\u627E\u5230\u6B4C\u8BCD\u5143\u7D20`),null;let e=betterncm.utils.debounce(r=>{for(let o of r){let i={time:Date.now(),duration:0,originalLyric:"",translatedLyric:""};return o.addedNodes[2]?(i.originalLyric=o.addedNodes[0].firstChild?.textContent||"",i.translatedLyric=o.addedNodes[2].firstChild?.textContent||""):o.addedNodes[0]&&(i.originalLyric=o.addedNodes[0].textContent||""),{lines:[i]}}},50);return u=new MutationObserver(e),u.observe(t,{childList:!0,subtree:!0}),{lines:[]}}catch(t){return console.error(`[${n}] \u76D1\u542C\u6B4C\u8BCD\u5931\u8D25:`,t),null}}function N(){u&&(u.disconnect(),u=null)}async function P(t,e=0){try{switch(N(),e){case 0:let r=await A();return r||h(t);case 1:return h(t);case 2:return O();default:return null}}catch(r){return console.error(`[${n}] \u5904\u7406\u6B4C\u8BCD\u5931\u8D25:`,r),null}}var d=class{constructor(e){this.port=e;this.socket=null;this.messageQueue=[];this.isDisposed=!1;this.connect()}get isConnected(){return this.socket?.readyState===WebSocket.OPEN}updatePort(e){this.port=e,this.disconnect(),this.connect()}connect(){if(!this.isDisposed)try{this.socket=new WebSocket(`ws://127.0.0.1:${this.port}`),this.socket.onopen=()=>{console.log(`[${n}] \u5DF2\u8FDE\u63A5\u5230 WebSocket \u670D\u52A1\u5668`),this.flushMessageQueue()},this.socket.onclose=()=>{console.log(`[${n}] \u4E0E\u670D\u52A1\u5668\u65AD\u5F00\u8FDE\u63A5\uFF0C\u5C06\u5728 3 \u79D2\u540E\u91CD\u8BD5...`),this.isDisposed||setTimeout(()=>this.connect(),3e3)},this.socket.onerror=e=>{console.error(`[${n}] WebSocket \u9519\u8BEF:`,e)}}catch(e){console.error(`[${n}] \u8FDE\u63A5\u5931\u8D25:`,e)}}disconnect(){this.socket&&(this.socket.close(),this.socket=null)}flushMessageQueue(){for(;this.messageQueue.length>0&&this.isConnected;){let e=this.messageQueue.shift();e&&this.socket.send(e)}}send(e,r){let o={type:e,timestamp:Date.now(),data:r},i=JSON.stringify(o);this.isConnected?this.socket.send(i):(this.messageQueue.push(i),this.messageQueue.length>S.MAX_QUEUE_SIZE&&this.messageQueue.shift())}sendSongChange(e){this.send("song",e)}sendProgress(e){this.send("progress",e)}sendError(e){this.send("error",{message:e})}sendLyric(e){this.send("lyric",e)}dispose(){this.isDisposed=!0,this.messageQueue=[],this.disconnect()}};function I({onSave:t,onLyricSourceChange:e,defaultPort:r,defaultLyricSource:o}){let[i,g]=React.useState(r),[p,f]=React.useState(r),[m,L]=React.useState(o),[v,E]=React.useState(o),[D,b]=React.useState(!1);React.useEffect(()=>{betterncm.app.readConfig(a.PORT,r.toString()).then(s=>{f(Number(s)),g(Number(s))}),betterncm.app.readConfig(a.LYRIC_SOURCE,o.toString()).then(s=>{let R=Number(s);E(R),L(R)})},[]);let T=()=>{let s=Number(i);!isNaN(s)&&s>=1&&s<=65535&&(t(s),f(s),e(m),E(m),b(!0),setTimeout(()=>b(!1),2e3))};return React.createElement("div",{style:{padding:"20px",color:"#000"}},React.createElement("div",{style:{display:"flex",gap:"10px",marginBottom:"20px"}},React.createElement("select",{value:m,onChange:s=>L(Number(s.target.value)),style:{padding:"5px",flex:1,color:"#000"}},React.createElement("option",{value:0},c[0]),React.createElement("option",{value:1},c[1]),React.createElement("option",{value:2},c[2])),React.createElement("input",{type:"number",value:i,onChange:s=>g(Number(s.target.value)),style:{padding:"5px",flex:1,color:"#000"}}),React.createElement("button",{onClick:T,style:{padding:"5px 10px",color:"#000",position:"relative"}},"\u4FDD\u5B58")),React.createElement("div",{style:{fontSize:"12px",color:"#000"}},React.createElement("div",null,`\u5F53\u524D\u6B4C\u8BCD\u6765\u6E90\uFF1A${c[v]}`),React.createElement("div",null,`\u5F53\u524D\u7AEF\u53E3\uFF1A${p}`)),D&&React.createElement("div",{style:{position:"absolute",bottom:"10px",left:"50%",transform:"translateX(-50%)",backgroundColor:"rgba(0, 0, 0, 0.7)",color:"#fff",padding:"8px 16px",borderRadius:"4px",fontSize:"12px",animation:"fadeIn 0.3s"}},"\u4FDD\u5B58\u6210\u529F"))}var l=null;async function _(){try{await betterncm.utils.waitForFunction(()=>{let t=betterncm.ncm.getPlayingSong()?.data;return t?(console.log(`[${n}] \u64AD\u653E\u6570\u636E\u5DF2\u52A0\u8F7D:`,t.name),!0):!1},100)}catch(t){throw console.error(`[${n}] \u7B49\u5F85\u64AD\u653E\u6570\u636E\u8D85\u65F6`),t}}function x(){let t=betterncm.ncm.getPlayingSong();return t?.data?{id:t.data.id,name:t.data.name,alias:t.data.alias||[],artists:t.data.artists?.map(e=>({id:e.id,name:e.name}))||[],album:{id:t.data.album?.id,name:t.data.album?.name,picUrl:t.data.album?.picUrl},duration:t.data.duration,transNames:t.data.transNames}:null}async function y(){let t=x();if(!t)return;let e=Number(await betterncm.app.readConfig(a.LYRIC_SOURCE,0 .toString())),r=await P(t.id,e);l?.sendSongChange({...t}),r&&l?.sendLyric(r)}function M(){legacyNativeCmder.appendRegisterCall("Load","audioplayer",y);let t=(e,r)=>{let o=x();if(!o)return;let i={time:r,formatted:`${Math.floor(r/60)}:${String(Math.floor(r%60)).padStart(2,"0")}`,percentage:r/(o.duration/1e3)*100};l?.sendProgress(i)};legacyNativeCmder.appendRegisterCall("PlayProgress","audioplayer",t)}plugin.onLoad(async()=>{try{await _();let t=Number(await betterncm.app.readConfig(a.PORT,35010 .toString()));l=new d(t),M(),await y()}catch(t){console.error(`[${n}] \u63D2\u4EF6\u52A0\u8F7D\u5931\u8D25:`,t),l?.sendError(String(t))}});plugin.onConfig(()=>{let t=document.createElement("div");return ReactDOM.render(React.createElement(I,{onSave:e=>{betterncm.app.writeConfig(a.PORT,e.toString()),console.log(`[${n}] \u7AEF\u53E3\u5DF2\u66F4\u65B0:`,e),l?.updatePort(e)},onLyricSourceChange:async e=>{await betterncm.app.writeConfig(a.LYRIC_SOURCE,e.toString()),await y()},defaultPort:35010,defaultLyricSource:0}),t),t});})();
