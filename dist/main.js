(()=>{var i="LyricsToPort",b=35010;var g={[0]:"RefinedNowPlaying",[1]:"LibLyric",[2]:"\u8F6F\u4EF6\u5185\u6B4C\u8BCD"},p={PORT:`${i}.config.port`,LYRIC_SOURCE:`${i}.config.lyricSource`};var v=null;async function _(t){if(!window.onProcessLyrics)return console.log(`[${i}] RefinedNowPlaying \u672A\u52A0\u8F7D`),null;await betterncm.utils.waitForFunction(()=>window.currentLyrics?.hash?.includes(t),100);let n=window.currentLyrics;return n?.lyrics?.length>0?{lines:n.lyrics}:null}async function T(t){let n=await loadedPlugins.liblyric.getLyricData(t);if(console.log(`[${i}] \u539F\u59CB\u6B4C\u8BCD\u6570\u636E:`,n),n.code!==200)return console.error(`[${i}] \u6B4C\u8BCDAPI\u9519\u8BEF:`,n.error),null;let e=(n.lrc?.lyric??"").replace(/\u3000/g," "),r=n.tlyric?.lyric??"",o=n.romalrc?.lyric??"",d=n.yrc?.lyric??"";return{lines:loadedPlugins.liblyric.parseLyric(e,r,o,d)}}async function B(){try{let t=await betterncm.utils.waitForElement(".j-flag.m-lyric",100);if(!t)return console.error(`[${i}] \u65E0\u6CD5\u627E\u5230\u6B4C\u8BCD\u5143\u7D20`),null;let n=t.querySelector(".z-sel");if(!n)return null;let e=o=>({time:Date.now(),duration:0,originalLyric:o.querySelector(".f-thide")?.textContent||"",translatedLyric:o.querySelector(".f-thide.f-brk")?.textContent||""});return v||(v=new MutationObserver(o=>{for(let d of o){let l=d.addedNodes;if(l.length>0){let u={basic:"",extra:""};l[2]?(u.basic=l[0].firstChild?.textContent||"",u.extra=l[2].firstChild?.textContent||""):u.basic=l[0].textContent||"",console.log(`[${i}] \u6B4C\u8BCD\u66F4\u65B0:`,u)}}}),v.observe(t,{childList:!0,subtree:!0})),{lines:[e(n)]}}catch(t){return console.error(`[${i}] \u83B7\u53D6\u8F6F\u4EF6\u5185\u6B4C\u8BCD\u5931\u8D25:`,t),null}}async function w(t,n=0){try{let e=null;switch(n){case 0:e=await _(t),e||(e=await T(t));break;case 1:e=await T(t);break;case 2:e=await B();break}return e?(e.lines=e.lines.filter(r=>r.originalLyric.trim()!==""),e.lines.length===1&&e.lines[0].time===0&&e.lines[0].duration!==0?{lines:[]}:e):(console.error(`[${i}] \u65E0\u6CD5\u83B7\u53D6\u6B4C\u8BCD`),{lines:[]})}catch(e){return console.error(`[${i}] \u5904\u7406\u6B4C\u8BCD\u5931\u8D25:`,e),{lines:[]}}}var y=class{constructor(n){this.isConnected=!1;this.reconnectTimeout=200;this.isReconnecting=!1;this.lastReconnectTime=0;this.minReconnectInterval=1e3;this.port=n,this.startConnectionCheck()}async startConnectionCheck(){this.checkTimer&&clearInterval(this.checkTimer),this.checkTimer=setInterval(()=>{this.isConnected||this.checkConnection()},this.reconnectTimeout),this.checkConnection()}async checkConnection(){if(this.isReconnecting)return!1;let n=Date.now();if(n-this.lastReconnectTime<this.minReconnectInterval)return!1;try{if(this.isReconnecting=!0,this.lastReconnectTime=n,(await fetch(`http://127.0.0.1:${this.port}/ping`,{method:"GET"})).ok)return this.isConnected||(console.log(`[${i}] \u670D\u52A1\u5668\u5DF2\u8FDE\u63A5`),this.isConnected=!0,Promise.resolve().then(()=>this.onConnectionRestored())),!0}catch{this.isConnected&&(console.log(`[${i}] \u7B49\u5F85\u670D\u52A1\u5668\u8FDE\u63A5...`),this.isConnected=!1)}finally{this.isReconnecting=!1}return!1}async onConnectionRestored(){this.onReconnect&&this.isConnected&&!this.isReconnecting&&await this.onReconnect()}async sendRequest(n){if(!this.isConnected&&!await this.checkConnection()){console.log(`[${i}] \u670D\u52A1\u5668\u672A\u8FDE\u63A5`);return}n.timestamp=Date.now();try{let e=await fetch(`http://127.0.0.1:${this.port}`,{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`)}catch(e){let r=e instanceof Error?e.message:String(e);console.error(`[${i}] \u53D1\u9001\u8BF7\u6C42\u5931\u8D25:`,r),this.isConnected=!1}}async sendLyric(n){await this.sendRequest({type:"lyric",timestamp:0,data:n})}async sendSongInfo(n){await this.sendRequest({type:"song",timestamp:0,data:n})}async sendProgress(n,e){await this.sendRequest({type:"progress",timestamp:0,data:{time:n,duration:e}})}async sendPlayState(n){await this.sendRequest({type:"state",timestamp:0,data:{state:n}})}async updatePort(n){this.dispose(),this.port=n,this.isConnected=!1,await this.startConnectionCheck(),this.onReconnect&&await this.onReconnect()}dispose(){this.checkTimer&&(clearInterval(this.checkTimer),this.checkTimer=void 0),this.isConnected=!1}};var x=class{constructor(){this.listeners=[]}subscribe(n){return this.listeners.push(n),()=>{this.listeners=this.listeners.filter(e=>e!==n)}}emit(n){this.listeners.forEach(e=>e(n))}},f=new x;function E(){let[t,n]=React.useState({});React.useEffect(()=>{let r=f.subscribe(o=>{n(d=>({...d,...o}))});return()=>r()},[]);let e={container:{padding:"24px",backgroundColor:"#fff",borderRadius:"16px",boxShadow:"0 4px 20px rgba(0,0,0,0.05)",maxWidth:"900px",margin:"20px auto"},title:{fontSize:"20px",fontWeight:"bold",color:"#ff85a2",marginBottom:"24px",paddingBottom:"12px",borderBottom:"2px solid #ffd6e0"},grid:{display:"grid",gap:"24px",gridTemplateColumns:"repeat(auto-fit, minmax(300px, 1fr))"},section:{backgroundColor:"#fff9fa",padding:"20px",borderRadius:"12px",border:"1px solid #ffe4e8",transition:"transform 0.2s ease",":hover":{transform:"translateY(-2px)"}},sectionTitle:{fontSize:"16px",fontWeight:"bold",color:"#ff85a2",marginBottom:"16px"},content:{color:"#4a4a4a",lineHeight:"1.8"},progressBar:{width:"100%",height:"6px",backgroundColor:"#ffe4e8",borderRadius:"4px",overflow:"hidden",marginBottom:"12px"},progressFill:r=>({width:`${r}%`,height:"100%",backgroundColor:"#ff85a2",transition:"width 0.3s ease"}),label:{color:"#888",fontSize:"14px",minWidth:"60px",display:"inline-block"},value:{color:"#4a4a4a",marginLeft:"12px",fontSize:"14px"},lyricLine:r=>({padding:"6px 0",color:r?"#ff85a2":"#666",transition:"all 0.3s ease",fontSize:"14px",fontWeight:r?"500":"normal"}),playState:{display:"flex",alignItems:"center",justifyContent:"center",fontSize:"16px",color:"#ff85a2"}};return h("div",{style:e.container},h("div",{style:e.title},"\u64AD\u653E\u72B6\u6001\u76D1\u89C6\u5668"),h("div",{style:e.grid},h("div",{style:e.section},h("div",{style:e.sectionTitle},"\u6B4C\u66F2\u4FE1\u606F"),t.song?h("div",{style:e.content},h("div",null,h("span",{style:e.label},"\u6807\u9898:"),h("span",{style:e.value},t.song.name)),h("div",null,h("span",{style:e.label},"\u6B4C\u624B:"),h("span",{style:e.value},t.song.artists.map(r=>r.name).join(" / "))),h("div",null,h("span",{style:e.label},"\u4E13\u8F91:"),h("span",{style:e.value},t.song.album.name)),t.song.alias.length>0&&h("div",null,h("span",{style:e.label},"\u522B\u540D:"),h("span",{style:e.value},t.song.alias.join(" / ")))):h("div",{style:e.content},"\u65E0\u64AD\u653E\u4FE1\u606F")),h("div",{style:e.section},h("div",{style:e.sectionTitle},"\u64AD\u653E\u8FDB\u5EA6"),t.progress?h("div",{style:e.content},h("div",{style:e.progressBar},h("div",{style:e.progressFill(t.progress.time/t.progress.duration*100)})),h("div",{style:{marginTop:"8px",display:"flex",justifyContent:"space-between"}},h("span",null,Math.floor(t.progress.time/1e3),"s"),h("span",null,Math.floor(t.progress.duration/1e3),"s"))):h("div",{style:e.content},"\u672A\u64AD\u653E")),h("div",{style:e.section},h("div",{style:e.sectionTitle},"\u6B4C\u8BCD"),h("div",{style:e.content},t.lyrics?.lines.map((r,o)=>h("div",{key:o,style:e.lyricLine(r.time<=(t.progress?.time||0)&&r.time+(r.duration||0)>=(t.progress?.time||0))},r.originalLyric))||"\u65E0\u6B4C\u8BCD")),h("div",{style:e.section},h("div",{style:e.sectionTitle},"\u64AD\u653E\u72B6\u6001"),h("div",{style:e.content},h("div",{style:e.playState},t.playState==="resume"?"\u25B6 \u64AD\u653E\u4E2D":"\u23F8 \u5DF2\u6682\u505C")))))}function I({onSave:t,onLyricSourceChange:n,defaultPort:e,defaultLyricSource:r}){let[o,d]=React.useState(e),[l,u]=React.useState(r),[O,P]=React.useState(!1);React.useEffect(()=>{betterncm.app.readConfig(p.PORT,e.toString()).then(s=>{d(Number(s))}),betterncm.app.readConfig(p.LYRIC_SOURCE,r.toString()).then(s=>{u(Number(s))})},[e,r]);let A=async()=>{let s=Number(o);!isNaN(s)&&s>=1&&s<=65535&&(await t(s),await n(l),P(!0),setTimeout(()=>P(!1),2e3))},D=async s=>{let m=Number(s.target.value);u(m),await n(m)},c={container:{padding:"24px",maxWidth:"900px",margin:"20px auto",backgroundColor:"#fff",borderRadius:"16px",boxShadow:"0 4px 20px rgba(0,0,0,0.05)"},title:{fontSize:"20px",fontWeight:"bold",color:"#ff85a2",marginBottom:"24px",paddingBottom:"12px",borderBottom:"2px solid #ffd6e0"},section:{marginBottom:"24px",padding:"20px",backgroundColor:"#fff9fa",borderRadius:"12px",border:"1px solid #ffe4e8"},sectionTitle:{fontSize:"16px",fontWeight:"bold",color:"#ff85a2",marginBottom:"16px"},label:{display:"block",color:"#666",fontSize:"14px"},inputGroup:{display:"flex",alignItems:"center",gap:"16px"},input:{padding:"10px 16px",border:"1px solid #ffd6e0",borderRadius:"8px",fontSize:"14px",width:"140px",transition:"all 0.3s",backgroundColor:"#fff",color:"#333",":focus":{borderColor:"#ff85a2",boxShadow:"0 0 0 3px rgba(255,133,162,0.1)",outline:"none"}},select:{padding:"10px 16px",border:"1px solid #ffd6e0",borderRadius:"8px",fontSize:"14px",width:"220px",backgroundColor:"#fff",cursor:"pointer",color:"#333"},option:{color:"#333",backgroundColor:"#fff"},button:{padding:"10px 24px",backgroundColor:"#ff85a2",color:"#fff",border:"none",borderRadius:"8px",fontSize:"14px",cursor:"pointer",transition:"all 0.3s",":hover":{backgroundColor:"#ff9db5"}},toast:{position:"fixed",bottom:"24px",left:"50%",transform:"translateX(-50%)",padding:"12px 24px",backgroundColor:"rgba(255,133,162,0.9)",color:"#fff",borderRadius:"8px",fontSize:"14px",boxShadow:"0 4px 12px rgba(255,133,162,0.2)",animation:"fadeIn 0.3s"}};return h("div",{style:c.container},h("div",{style:c.title},"\u63D2\u4EF6\u914D\u7F6E"),h("div",{style:c.section},h("div",{style:c.sectionTitle},"\u670D\u52A1\u7AEF\u53E3"),h("div",{style:c.inputGroup},h("input",{type:"number",value:o,onChange:s=>d(Number(s.target.value)),style:c.input,min:"1",max:"65535"}),h("button",{onClick:A,style:c.button},"\u4FDD\u5B58"))),h("div",{style:c.section},h("div",{style:c.sectionTitle},"\u6B4C\u8BCD\u6765\u6E90"),h("select",{value:l,onChange:D,style:c.select},Object.entries(g).map(([s,m])=>h("option",{key:s,value:s,style:c.option},m)))),h(E,null),O&&h("div",{style:{position:"fixed",bottom:"24px",left:"50%",transform:"translateX(-50%)",padding:"12px 24px",backgroundColor:"rgba(255,133,162,0.9)",color:"#fff",borderRadius:"8px",fontSize:"14px",boxShadow:"0 4px 12px rgba(255,133,162,0.2)",animation:"fadeIn 0.3s"}},"\u8BBE\u7F6E\u5DF2\u4FDD\u5B58"))}function N(t,n){let e=!1;return function(...r){if(!e){let o=t.apply(this,r);return e=!0,setTimeout(()=>e=!1,n),o}}}var a=null,S=null,M=0,C="pause";async function F(t,n){let e=await betterncm.app.readConfig(t,String(n));return typeof n=="number"?Number(e):e}async function k(t,n){await betterncm.app.writeConfig(t,String(n)),console.log(`[${i}] \u914D\u7F6E\u5DF2\u4FDD\u5B58:`,{key:t,value:n})}async function G(){try{await betterncm.utils.waitForFunction(()=>{let t=betterncm.ncm.getPlayingSong()?.data;return t?(console.log(`[${i}] \u64AD\u653E\u6570\u636E\u5DF2\u52A0\u8F7D:`,t.name),!0):!1},100)}catch(t){let n=t instanceof Error?t.message:String(t);throw console.error(`[${i}] \u7B49\u5F85\u64AD\u653E\u6570\u636E\u8D85\u65F6:`,n),t}}function L(){let t=betterncm.ncm.getPlayingSong();return t?.data?{id:t.data.id,name:t.data.name,alias:t.data.alias||[],artists:t.data.artists?.map(n=>({id:n.id,name:n.name}))||[],album:{id:t.data.album?.id||0,name:t.data.album?.name||"",picUrl:t.data.album?.picUrl||""},duration:t.data.duration,transNames:t.data.transNames}:(console.log(`[${i}] \u83B7\u53D6\u5F53\u524D\u6B4C\u66F2\u6570\u636E\u5931\u8D25`),null)}async function R(){let t=L();if(!t)return;let n=Number(await betterncm.app.readConfig(p.LYRIC_SOURCE,0 .toString())),e=await w(t.id,n);S=e,console.log(`[${i}] \u4ECE\u6B4C\u8BCD\u6E90"${g[n]}"\u83B7\u53D6\u5230\u300A${t.name}\u300B\u7684\u6B4C\u8BCD\uFF0C${e.lines.length}\u884C
`,e.lines),f.emit({song:t,lyrics:e}),await a?.sendSongInfo(t),await a?.sendLyric(e),await a?.sendPlayState(C)}var Y=N((t,n)=>{let e=L();if(!e)return;let r=Math.floor(n*1e3);r!==M&&(M=r,f.emit({progress:{time:r,duration:e.duration}}),a?.sendProgress(r,e.duration))},100),U=async(t,n)=>{let[e,r]=n.split("|");if(r!=="resume"&&r!=="pause"){console.error(`[${i}] \u672A\u77E5\u7684\u64AD\u653E\u72B6\u6001:`,r);return}f.emit({playState:r}),C=r,a?.sendPlayState(r)};function z(){legacyNativeCmder.appendRegisterCall("Load","audioplayer",R),legacyNativeCmder.appendRegisterCall("PlayProgress","audioplayer",Y),legacyNativeCmder.appendRegisterCall("PlayState","audioplayer",U)}function q(){legacyNativeCmder.removeRegisterCall("Load","audioplayer"),legacyNativeCmder.removeRegisterCall("PlayProgress","audioplayer"),legacyNativeCmder.removeRegisterCall("PlayState","audioplayer")}plugin.onConfig(()=>{let t=document.createElement("div");return ReactDOM.render(React.createElement(I,{onSave:async n=>{await k(p.PORT,n),await a?.updatePort(n)},onLyricSourceChange:async n=>{await k(p.LYRIC_SOURCE,n),await R()},defaultPort:b,defaultLyricSource:0}),t),t});plugin.onLoad(async()=>{try{await G();let t=await F(p.PORT,b);a=new y(t),a.onReconnect=async()=>{let n=L();n&&(await a?.sendSongInfo(n),S&&await a?.sendLyric(S),await a?.sendPlayState(C))},await R(),z(),window.addEventListener("beforeunload",()=>{q(),a?.dispose(),a=null})}catch(t){let n=t instanceof Error?t.message:String(t);console.error(`[${i}] \u63D2\u4EF6\u52A0\u8F7D\u5931\u8D25:`,n)}});})();
